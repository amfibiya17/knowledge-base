# 2.09 useSyncExternalStore

This file introduces the `useSyncExternalStore` hook.  
`useSyncExternalStore` is used to **safely subscribe to external data sources** in React.

This hook exists mainly to support **external stores** (outside React state), especially with concurrent rendering.

---

## What `useSyncExternalStore` is

`useSyncExternalStore` is a React hook that allows a component to:

- read data from an external store
- subscribe to changes in that store
- stay consistent with React’s rendering model

It is designed for **state that lives outside React**.

---

## What an external store is

An **external store** is any state that is:

- not managed by React state or hooks
- shared outside the React component tree
- updated independently of React

Examples include:

- Redux stores
- Zustand stores
- browser APIs that change over time (e.g. `window.location`)
- custom event-based stores
- shared mutable objects

---

## Why `useSyncExternalStore` exists

Before this hook, subscribing to external data was **unsafe** with concurrent rendering.

Problems included:

- tearing (UI reading inconsistent values)
- stale snapshots
- race conditions during rendering

`useSyncExternalStore` solves this by ensuring React always reads a **consistent snapshot**.

---

## Basic syntax

```jsx
const value = useSyncExternalStore(subscribe, getSnapshot);
```

Where:

- `subscribe` → tells React how to listen for changes
- `getSnapshot` → returns the current value from the store

---

## Example: simple external store

```jsx
let count = 0;
const listeners = new Set();

function subscribe(listener) {
  listeners.add(listener);
  return () => listeners.delete(listener);
}

function getSnapshot() {
  return count;
}

function increment() {
  count++;
  listeners.forEach((listener) => listener());
}
```

---

## Using the store in a component

```jsx
function Counter() {
  const count = useSyncExternalStore(subscribe, getSnapshot);

  return <button onClick={increment}>Count: {count}</button>;
}
```

---

## What happens here

- component renders
- React calls `getSnapshot` to read the value
- React subscribes using `subscribe`
- when the store updates, React re-renders
- UI reflects the new external value

React always sees a **consistent snapshot**.

---

## What `subscribe` does

The `subscribe` function:

- registers a listener
- returns a cleanup function
- notifies React when the store changes

React decides **when** to re-render, not the store.

---

## What `getSnapshot` does

`getSnapshot`:

- returns the current store value
- must be synchronous
- must always return the same value if nothing changed

This guarantees **render consistency**.

---

## Server-side rendering support

`useSyncExternalStore` also supports SSR:

```jsx
useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot);
```

`getServerSnapshot` provides the initial value during server rendering.

---

## When to use `useSyncExternalStore`

Use it when:

- integrating with external state libraries
- reading shared mutable state
- subscribing to browser APIs
- building custom state containers
- working with concurrent features

Most apps **do not need it directly**.

Most developers will only encounter this hook indirectly through libraries.

> If you are unsure whether you need this hook, you probably don’t.

---

## When NOT to use it

Do **not** use it for:

- normal component state
- replacing `useState` or `useReducer`
- simple shared state (use context instead)
- local UI state

If React owns the state → **don’t use this hook**.

---

## `useSyncExternalStore` and performance

Important points:

- React controls when re-renders happen
- all consumers update when the store changes
- store logic must be efficient

Often used internally by libraries, not app code.

---

## What `useSyncExternalStore` does NOT do

- It does not store state
- It does not replace state libraries
- It does not prevent re-renders
- It does not simplify app logic

It is a **low-level integration hook**.

---

## Common mistakes

- Using it instead of `useState`
- Writing non-synchronous `getSnapshot`
- Mutating store without notifying subscribers
- Using it when context or props are enough

---

## Mental model

- External store → owns the data
- React → reads snapshots
- `subscribe` → tells React when data changes
- `getSnapshot` → tells React what the data is
- React → decides when to re-render

Think of it as **React safely observing external state**.

---

## Summary

- `useSyncExternalStore` connects React to external stores
- It guarantees consistent snapshots
- It is designed for concurrent rendering
- Mostly used by libraries, not applications
- Not a replacement for React state
- Use only when integrating external state systems
